#!/bin/sh

# Pre-commit: decideix el bump a partir del missatge i
# inclou els fitxers de versió en el mateix commit.

set -e

MSG_FILE="$(git rev-parse --git-path COMMIT_EDITMSG)"
[ -f "$MSG_FILE" ] || exit 0

MSG_CONTENT="$(cat "$MSG_FILE")"

# Si ja hi ha package.json o js/version.js staged, no tornar a fer bump
if git diff --cached --name-only | grep -qE '^(package.json|js/version.js)$'; then
  exit 0
fi

# Ometre merges o reverts
case "$MSG_CONTENT" in
  Merge\ *|Revert\ *)
    exit 0
    ;;
esac

TYPE="patch"

# Major: BREAKING CHANGE(S) o tipus amb ! (p.ex. feat!:)
echo "$MSG_CONTENT" | grep -qiE 'BREAKING CHANGE|BREAKING CHANGES' && TYPE="major"
if [ "$TYPE" != "major" ]; then
  echo "$MSG_CONTENT" | head -n1 | grep -qiE '^[a-z]+(\([^)]+\))?!:' && TYPE="major"
fi

# Minor: comença per feat
if [ "$TYPE" != "major" ]; then
  echo "$MSG_CONTENT" | head -n1 | grep -qiE '^feat(\([^)]+\))?:' && TYPE="minor"
fi

echo "Decidint increment de versió segons el missatge: $TYPE"

node scripts/bump-version.js "$TYPE"

# Incloure els fitxers de versió al mateix commit
git add package.json js/version.js

exit 0
