#!/bin/sh

# pre-commit: determines the version bump from the commit message
# and stages the versioned files in the same commit.

set -e

MSG_FILE="$(git rev-parse --git-path COMMIT_EDITMSG)"
[ -f "$MSG_FILE" ] || exit 0

MSG_CONTENT="$(cat "$MSG_FILE")"

# If package.json or js/version.js are already staged, skip the bump
if git diff --cached --name-only | grep -qE '^(package.json|js/version.js)$'; then
  exit 0
fi

# Skip merges or reverts
case "$MSG_CONTENT" in
  Merge\ *|Revert\ *)
    exit 0
    ;;
esac

TYPE="patch"

# Major: BREAKING CHANGE(S) or scope!
echo "$MSG_CONTENT" | grep -qiE 'BREAKING CHANGE|BREAKING CHANGES' && TYPE="major"
if [ "$TYPE" != "major" ]; then
  echo "$MSG_CONTENT" | head -n1 | grep -qiE '^[a-z]+(\([^)]+\))?!:' && TYPE="major"
fi

# Minor: feat
if [ "$TYPE" != "major" ]; then
  echo "$MSG_CONTENT" | head -n1 | grep -qiE '^feat(\([^)]+\))?:' && TYPE="minor"
fi

echo "Determinando incremento de versión según el mensaje: $TYPE"

node scripts/bump-version.js "$TYPE"

# Stage version files in the same commit
git add package.json js/version.js

exit 0
