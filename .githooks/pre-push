#!/bin/sh

# pre-push: stops redundant pushes and enforces rebases when needed
# - Blocks redundant pushes (nothing new to upload)
# - Forces a rebase when the remote is ahead

set -e

# If there is no upstream configured, allow the push (first push)
upstream="$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || true)"
[ -z "$upstream" ] && exit 0

local="$(git rev-parse @)"
remote="$(git rev-parse "$upstream" 2>/dev/null || true)"
base="$(git merge-base @ "$upstream" 2>/dev/null || true)"

# Redundant push: nothing to send
if [ "$local" = "$remote" ]; then
  echo "⚠️ Nada que enviar (evitando push redundante)."
  exit 1
fi

# Unknown remote (first push to this upstream)
[ -z "$remote" ] && exit 0

# Remote ahead: require rebase
if [ "$base" = "$local" ]; then
  echo "⚠️ La rama remota tiene commits nuevos."
  echo "   Ejecuta: git pull --rebase --autostash"
  exit 1
fi

# Divergent histories: ask for manual rebase
if [ "$base" != "$remote" ]; then
  echo "⚠️ Historias divergentes. Haz rebase antes del push."
  echo "   git pull --rebase --autostash"
  exit 1
fi

exit 0
